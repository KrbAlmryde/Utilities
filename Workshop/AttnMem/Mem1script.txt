#!/usr/bin/env tcsh
echo "auto-generated by afni_proc.py, Mon Jun 30 11:23:00 2008"
echo "(version 1.28, Jan 28, 2008)"

# execute via : tcsh -x S#-run-script |& tee output.S#-run-script

# --------------------------------------------------
# script setup

# the user may specify a single subject to run with

set images_home = ~/kyledocuments

if ( $#argv > 0 ) then  
    set subj = $argv[1] 
else                    
#set subj = S1      
set subj = $1      

endif

# set type
set type = $2

# set Base Number
set base = $3

# assign output directory name
set output_dir = ${subj}_${type}_results

# verify that the results directory does not yet exist
if ( -d $output_dir ) then 
    echo output dir "${subj}_${type}_results" already exists

    exit

endif


# create results directory
mkdir $output_dir

# create stimuli directory, and copy stim files
mkdir $output_dir/stimuli

cp  fa_mem1 ff_mem1 nf_mem1 mf_mem1 $output_dir/stimuli

# move Anatomical spgr files to prep for warping to Talairach space

cp *spgr+tlrc* $images_home/attnmem/AnovaData/Indiv_memory/Mem1-step1
cp *spgr+orig* $images_home/attnmem/AnovaData/Indiv_memory/Mem1-step1

echo "Living Easy"


# -------------------------------------------------------
# apply 3dTcat to copy input dsets to results dir, while
#Then remove 8 TRs from concatenated data

3dTcat -prefix $output_dir/${subj}_${type}_tcat ${subj}-mem1-epan+orig'[7..234]'

# and enter the results directory
cd $output_dir

echo "Loving Free!"

# -------------------------------------------------------
# run 3dToutcount and 3dTshift for BRIK and HEAD File

3dToutcount -automask ${subj}_${type}_tcat+orig > precount_${subj}_${type}.1D 

3dToutcount -save ${subj}_${type}_outlierInfo ${subj}_${type}_tcat+orig

1dplot -one  precount_${subj}_${type}.1D

3dTshift -tzero 0 -rlt+ -quintic -prefix ${subj}_${type}_tshift      \
             ${subj}_${type}_tcat+orig

3dToutcount -automask ${subj}_${type}_tshift+orig > postcount_${subj}_${type}.1D

3dToutcount -save ${subj}_${type}_shiftInfo ${subj}_${type}_tshift+orig

1dplot -one  postcount_${subj}_${type}.1D

echo "Season ticket on a one-way ride"

# -------------------------------------------------------
# align each dset to the base volume

    3dvolreg -verbose -zpad 1 -base ${subj}_${type}_tshift+orig"[${base}]"  \
             -1Dfile dfile-$type.1D -prefix ${subj}_${type}_volreg  \
             -cubic                                                  \
             ${subj}_${type}_tshift+orig


# make a single file of registration params
cat dfile-$type.1D > dfile-$type.1D

echo "Asking nothing, leave me be!"

# -------------------------------------------------------
# blur each volume

    3dmerge -1blur_fwhm 8.0 -doall -prefix ${subj}_${type}_blur   \
            ${subj}_${type}_volreg+orig

echo "Taking everything in my stride!"

# -------------------------------------------------------
# create 'full_mask' dataset (union mask)

    3dAutomask -prefix ${subj}_${type}_automask ${subj}_${type}_blur+orig

echo "Dont need reason, dont need rhyme"

# -------------------------------------------------------
# norm each voxel time series to have a mean of 100
# (subject to maximum value of 200)

    3dTstat -prefix ${subj}_${type}_mean ${subj}_${type}_blur+orig
    3dcalc -a ${subj}_${type}_blur+orig -b ${subj}_${type}_mean+orig  \
           -c ${subj}_${type}_automask+orig                              \
           -expr "(a/b * 100) * c"                        \
           -prefix ${subj}_${type}_norm

echo "Aint nothing I would rather do"

# -------------------------------------------------------
# run the regression analysis
3dDeconvolve -input ${subj}_${type}_norm+orig.HEAD                     \
#  -censor stimuli/censorMem1.1D				\
    -num_stimts 4                                                      \
    -stim_times 1 stimuli/mf_mem1 'GAM'                   \
    -stim_label 1 mf_memory                                        \
    -stim_times 2 stimuli/ff_mem1 'GAM'                  \
    -stim_label 2 ff_memory                                       \
    -stim_times 3 stimuli/nf_mem1 'GAM'                  \
    -stim_label 3 nf_memory                                       \
    -stim_times 4 stimuli/fa_mem1 'GAM'                   \
    -stim_label 4 fa_memory                                        \
    -iresp 1 ${subj}_${type}_mf-norm-irf -TR_times 0.575 \
    -iresp 2 ${subj}_${type}_ff-norm-irf -TR_times 0.575 \
    -iresp 3 ${subj}_${type}_nf-norm-irf -TR_times 0.575 \
    -iresp 4 ${subj}_${type}_fa-norm-irf -TR_times 0.575 \
    -full_first -fout -tout -nobout -polort A			      \
    -progress 1000							      \
    -bucket ${subj}_${type}_stats

  

# create an all_runs dataset to match the fitts, errts, etc.
3dTcat -prefix all_runs$subj ${subj}_${type}_norm+orig.HEAD

echo "Going down, Party Time!" 

# -------------------------------------------------------
# Extract sub-brick data

3dbucket -prefix ${subj}_${type}_fa-peak-irf+orig -fbuc ${subj}_${type}_fa-norm-irf+orig'[8]'

3dbucket -prefix ${subj}_${type}_ff-peak-irf+orig -fbuc ${subj}_${type}_ff-norm-irf+orig'[8]'

3dbucket -prefix ${subj}_${type}_mf-peak-irf+orig -fbuc ${subj}_${type}_mf-norm-irf+orig'[8]'

3dbucket -prefix ${subj}_${type}_nf-peak-irf+orig -fbuc ${subj}_${type}_nf-norm-irf+orig'[8]'

mv *irf* $images_home/attnmem/AnovaData/Indiv_memory/Mem1-step1

echo "My friends are gonna be there too!"

# -------------------------------------------------------
# return to parent directory
cd ../../${subj}

# -------------------------------------------------------
# Change directories to Mem1-step1, Warp sub-bricked Tstat files to Talairach space
cd ../AnovaData/Indiv_memory/Mem1-step1

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${type}_mf-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${type}_ff-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${type}_nf-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${type}_fa-peak-irf+orig

# -------------------------------------------------------

echo "Dont Stop Me!"

end