#!/usr/bin/env tcsh
echo "auto-generated by afni_proc.py, Mon Jun 30 11:23:00 2008"
echo "(version 1.28, Jan 28, 2008)"

# execute via : tcsh -x S#-run-script |& tee output.S#-run-script

# --------------------------------------------------
# script setup

# the user may specify a single subject to run with

set images_home = ~/kyledocuments

if ( $#argv > 0 ) then  
    set subj = $argv[1] 
else                    
#set subj = S1      
set subj = $1      

endif

# set first run
set run1 = $2

# set second run
set run2=$3

#set set group run
set run3=$4

# set Base Number
set base = $5

# assign output directory name
set output_dir = ${subj}_${run3}_results

# verify that the results directory does not yet exist
if ( -d $output_dir ) then 
    echo output dir "${subj}_${run3}_results" already exists

    exit

endif


# create results directory
mkdir $output_dir

# create stimuli directory, and copy stim files
mkdir $output_dir/stimuli

cp  fa_memboth ff_memboth nf_memboth mf_memboth censorConCat.1D TR.1D $output_dir/stimuli

# move Anatomical spgr files to prep for warping to Talairach space

cp *spgr+tlrc* $images_home/attnmem/AnovaData/Smoothless
cp *spgr+orig* $images_home/attnmem/AnovaData/Smoothless

echo "Living Easy"

# -------------------------------------------------------
# apply 3dTcat to copy input dsets to results dir, while
#Then remove 8 TRs from concatenated data

3dTcat -prefix $output_dir/${subj}_${run1}_tcat ${subj}-mem1-epan+orig'[7..234]'

3dTcat -prefix $output_dir/${subj}_${run2}_tcat ${subj}-mem2-epan+orig'[8..221]'

# and enter the results directory
cd $output_dir

echo "Loving Free!"

# -------------------------------------------------------
# run 3dToutcount and 3dTshift for BRIK and HEAD File - RUN 1

3dToutcount -automask ${subj}_${run1}_tcat+orig > precount_${subj}_${run1}.1D 

3dToutcount -save ${subj}_${run1}_outlierInfo ${subj}_${run1}_tcat+orig

1dplot -one  precount_${subj}_${run1}.1D

3dTshift -tzero 0 -rlt+ -quintic -prefix ${subj}_${run1}_tshift      \
             ${subj}_${run1}_tcat+orig

3dToutcount -automask ${subj}_${run1}_tshift+orig > postcount_${subj}_${run1}.1D

3dToutcount -save ${subj}_${run1}_shiftInfo ${subj}_${run1}_tshift+orig

1dplot -one  postcount_${subj}_${run1}.1D

echo "Season ticket on a one-way ride"

# -------------------------------------------------------


# align each dset to the base volume

    3dvolreg -verbose -zpad 1 -base ${subj}_${run1}_tcat+orig"[${base}]"  \
             -1Dfile dfile-$run1.1D -prefix ${subj}_${run1}_volreg  \
             -cubic                                                  \
             ${subj}_${run1}_tshift+orig


# make a single file of registration params
cat dfile-$run1.1D > dfile-$run1.1D

echo "Asking nothing, leave me be!"

# -------------------------------------------------------
# create 'full_mask' dataset (union mask)

    3dAutomask -prefix ${subj}_${run1}_automask ${subj}_${run1}_volreg+orig

echo "Dont need reason, dont need rhyme"

# -------------------------------------------------------
# norm each voxel time series to have a mean of 100
# (subject to maximum value of 200)

    3dTstat -prefix ${subj}_${run1}_mean ${subj}_${run1}_volreg+orig
    3dcalc -a ${subj}_${run1}_volreg+orig -b ${subj}_${run1}_mean+orig  \
           -c ${subj}_${run1}_automask+orig                              \
           -expr "(a/b * 100) * c"                        \
           -prefix ${subj}_${run1}_norm

echo "Aint nothing I would rather do"

# -------------------------------------------------------
# run 3dToutcount and 3dTshift for BRIK and HEAD File - RUN2

3dToutcount -automask ${subj}_${run2}_tcat+orig > precount_${subj}_${run2}.1D 

3dToutcount -save ${subj}_${run2}_outlierInfo ${subj}_${run2}_tcat+orig

1dplot -one  precount_${subj}_${run2}.1D

3dTshift -tzero 0 -rlt+ -quintic -prefix ${subj}_${run2}_tshift      \
             ${subj}_${run2}_tcat+orig

3dToutcount -automask ${subj}_${run2}_tshift+orig > postcount_${subj}_${run2}.1D

3dToutcount -save ${subj}_${run2}_shiftInfo ${subj}_${run2}_tshift+orig

1dplot -one  postcount_${subj}_${run2}.1D

echo "Season ticket on a one-way ride"


# -------------------------------------------------------
# align each dset to the base volume

    3dvolreg -verbose -zpad 1 -base ${subj}_${run2}_tshift+orig"[${base}]"  \
             -1Dfile dfile-$run2.1D -prefix ${subj}_${run2}_volreg  \
             -cubic                                                  \
             ${subj}_${run2}_tshift+orig


# make a single file of registration params
cat dfile-$run2.1D > dfile-$run2.1D

echo "Asking nothing, leave me be!"

# -------------------------------------------------------
# create 'full_mask' dataset (union mask)

    3dAutomask -prefix ${subj}_${run2}_automask ${subj}_${run2}_volreg+orig

echo "Dont need reason, dont need rhyme"

# -------------------------------------------------------
# norm each voxel time series to have a mean of 100
# (subject to maximum value of 200)

    3dTstat -prefix ${subj}_${run2}_mean ${subj}_${run2}_volreg+orig
    3dcalc -a ${subj}_${run2}_volreg+orig -b ${subj}_${run2}_mean+orig  \
           -c ${subj}_${run2}_automask+orig                              \
           -expr "(a/b * 100) * c"                        \
           -prefix ${subj}_${run2}_norm

echo "Aint nothing I would rather do"

# -------------------------------------------------------
# Apply 3dTcat to Concatenate memory runs in order of Mem2 and Mem1 respectively

3dTcat -prefix ${subj}_${run3}_norm ${subj}_${run2}_norm+orig ${subj}_${run1}_norm+orig

echo "Loving Free!"

# -------------------------------------------------------
# run the regression analysis
3dDeconvolve -input ${subj}_${run3}_norm+orig.HEAD    		\
    #-censor stimuli/censorConCat.1D				\
    -num_stimts 4                                          	\
    -stim_times 1 stimuli/mf_memboth 'GAM'                   	\
    -stim_label 1 mf_memory                                     \
    -stim_times 2 stimuli/ff_memboth 'GAM'                  	\
    -stim_label 2 ff_memory                                     \
    -stim_times 3 stimuli/nf_memboth 'GAM'                  	\
    -stim_label 3 nf_memory                                     \
    -stim_times 4 stimuli/fa_memboth 'GAM'                   	\
    -stim_label 4 fa_memory                                     \
    -iresp 1 ${subj}_${run3}_mf-norm-irf -TR_times 0.575 	\
    -iresp 2 ${subj}_${run3}_ff-norm-irf -TR_times 0.575 	\
    -iresp 3 ${subj}_${run3}_nf-norm-irf -TR_times 0.575 	\
    -iresp 4 ${subj}_${run3}_fa-norm-irf -TR_times 0.575 	\
    -full_first -fout -tout -nobout -polort A			\
    -concat stimuli/TR.1D					\
    -progress 1000						\
    -bucket ${subj}_${run3}_stats

# create an all_runs dataset to match the fitts, errts, etc.
3dTcat -prefix all_runs$subj ${subj}_${run3}_norm+orig.HEAD

echo "Going down, Party Time!" 

# -------------------------------------------------------
# Extract sub-brick data

3dbucket -prefix ${subj}_${run3}_fa-peak-irf+orig -fbuc ${subj}_${run3}_fa-norm-irf+orig'[8]'

3dbucket -prefix ${subj}_${run3}_ff-peak-irf+orig -fbuc ${subj}_${run3}_ff-norm-irf+orig'[8]'

3dbucket -prefix ${subj}_${run3}_mf-peak-irf+orig -fbuc ${subj}_${run3}_mf-norm-irf+orig'[8]'

3dbucket -prefix ${subj}_${run3}_nf-peak-irf+orig -fbuc ${subj}_${run3}_nf-norm-irf+orig'[8]'

mv *irf* $images_home/attnmem/AnovaData/Smoothless

echo "My friends are gonna be there too!"

# -------------------------------------------------------
# return to parent directory
cd ../../${subj}

# -------------------------------------------------------
# Change directories to Smoothless, Warp sub-bricked Tstat files to Talairach space
cd ../AnovaData/Smoothless

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_mf-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_ff-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_nf-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_fa-peak-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_mf-norm-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_ff-norm-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_nf-norm-irf+orig

adwarp -apar ${subj}-spgr+tlrc -dpar ${subj}_${run3}_fa-norm-irf+orig


# -------------------------------------------------------


echo "Dont Stop Me!"

end
